{% extends "base.html" %}
{% block title %}Challenges{% endblock %}

{% block hero %}
<section class="relative bg-cyan-700 text-white text-center py-16 shadow-lg overflow-hidden">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-4xl md:text-5xl font-bold mb-2">üìÇ Challenges</h1>
    <p class="text-lg md:text-xl opacity-90">Overzicht per niveau. Klik door voor downloads &amp; details.</p>

    <div class="mt-4 flex flex-wrap justify-center gap-3">
      <a class="btn" href="{{ url_for('ch.challenges_download_all') }}">‚¨áÔ∏è Download alle challenges (.zip)</a>
    </div>

    <!-- Rail: countdown + ticker -->
    <div class="mt-5 rounded-lg border border-white/20 bg-white/10 backdrop-blur-[2px] overflow-hidden">
      <div id="countdown" class="font-mono py-2 px-3">‚è≥ Eindigtijd laden‚Ä¶</div>
      <div id="live-ticker" class="whitespace-nowrap overflow-hidden py-2 px-3 border-t border-white/20">
        ‚è≥ Laden van liveticker‚Ä¶
      </div>
    </div>
  </div>
</section>

<style>
@keyframes ticker-scroll { 0%{ transform: translateX(100%) } 100%{ transform: translateX(-100%) } }
#live-ticker.scrolling { animation: ticker-scroll 35s linear infinite; }
</style>

<script>
// === Countdown ===
// Tip: zet CTF_END_ISO server-side op lokale tijd (America/Kralendijk, UTC-4) bv. "2025-09-30T20:00:00-04:00"
// of laat 'm op UTC met "Z" staan; beide werken, zolang de intentie klopt.
(() => {
  try {
    const iso = "{{ CTF_END_ISO|default('2025-09-30T20:00:00Z') }}";
    const end = new Date(iso).getTime();
    const el = document.getElementById("countdown");
    if (el && !isNaN(end)) {
      const tick = () => {
        const diff = end - Date.now();
        if (diff <= 0) { el.textContent = "‚è∞ Game over!"; return; }
        const h = Math.floor(diff / 3_600_000);
        const m = Math.floor((diff % 3_600_000) / 60_000);
        const s = Math.floor((diff % 60_000) / 1_000);
        el.textContent = `‚è≥ Eindigt over ${h}u ${m}m ${s}s`;
      };
      tick();
      setInterval(tick, 1000);
    }
  } catch(e){}
})();

// === Liveticker ===
async function fetchTicker() {
  try {
    const r = await fetch("/api/ticker", { cache: "no-store" });
    const data = await r.json();
    const el = document.getElementById("live-ticker");
    if (!el) return;
    const text = (data.items && data.items.length)
      ? " üèÅ " + data.items.join("   ‚Ä¢   ")
      : "Nog geen solves‚Ä¶ keep hacking! üí™";
    el.textContent = text;

    // animatie herstarten
    el.classList.remove('scrolling');
    // force reflow
    void el.offsetWidth;
    el.classList.add('scrolling');
  } catch(e) {}
}
fetchTicker();
setInterval(fetchTicker, 15000);
</script>
{% endblock %}

{% block content %}
  {% for level_slug, lvl in data.items() %}
    <section class="bg-white rounded-xl shadow mb-4 overflow-hidden">
      <h2 class="m-0 px-5 py-3 bg-slate-100 text-slate-600 text-lg font-semibold">{{ lvl.label }}</h2>

      {% if lvl.challenges %}
        <ul class="list-none p-0 m-0">
          {% for c in lvl.challenges %}
            <li class="flex items-center justify-between border-t border-slate-200 px-5 py-3 gap-3">
              <div class="font-semibold">{{ c.title }}</div>
              <div class="flex gap-2 flex-wrap">
                <a class="btn" href="{{ url_for('ch.challenge_detail', cid=c.id) }}">Bekijken</a>
                <a class="btn" href="{{ url_for('ch.challenge_bundle', cid=c.id) }}">‚¨áÔ∏è zip</a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="px-5 py-3">(Nog geen challenges in deze categorie)</p>
      {% endif %}
    </section>
  {% endfor %}
{% endblock %}
